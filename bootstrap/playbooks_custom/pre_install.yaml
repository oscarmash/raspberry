- name: Custom pre install - SWAP
  hosts: k8s_cluster
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  tasks:

    - name: Disable SWAP since kubernetes can't work with swap enabled
      shell: |
        swapoff -a

    - name: Remove multiple packages
      apt:
        name:
          - dphys-swapfile
          - zram-tools
        state: absent

    - name: Disable SWAP in fstab since kubernetes can't work with swap enabled
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: Installing multiple packages
      apt:
        pkg:
          - ethtool
          - sudo
          - jq
        state: latest
        update_cache: true

- name: kubectl aliases
  hosts: kube_control_plane
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  vars:
    bashrc: /root/.bashrc
  tasks:

    - name: Alias kubectl
      lineinfile:
        path: "{{ bashrc }}"
        line: alias k='kubectl'
        create: true

    - name: Alias kubectl delete
      lineinfile:
        path: "{{ bashrc }}"
        line: alias kcdf='kubectl delete -f'
        create: true

    - name: Alias kubectl apply
      lineinfile:
        path: "{{ bashrc }}"
        line: alias kcaf='kubectl apply -f'
        create: true

    - name: Alias kubectl delete pod grace-period force
      lineinfile:
        path: "{{ bashrc }}"
        line: alias kcdp='kubectl delete pod --grace-period=0 --force'
        create: true

- name: Remove ntp install chrony
  hosts: k8s_cluster
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  tasks:

    - name: Remove "ntp, sntp, and systemd-timesyncd" packages
      ansible.builtin.apt:
        name:
          - ntp
          - sntp
          - systemd-timesyncd
        state: absent
        purge: true
      tags: chrony

    - name: Instalar paquet chrony
      ansible.builtin.apt:
        name:
          - chrony
        state: present
      tags: chrony

    - name: Enable chrony
      ansible.builtin.service:
        name: chrony
        enabled: true
      tags: chrony

    - name: Configure chrony
      ansible.builtin.copy:
        src: files/chrony.conf
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: '0644'
      tags: chrony
